<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Controle de Gastos</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;margin:0;background:#f6f7fb;color:#111}
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:16px 22px;background:#fff;border-bottom:1px solid #e9e9ee}
    .brand{font-weight:900;font-size:18px}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;border:1px solid transparent;background:#6d5efc;color:#fff;text-decoration:none;font-weight:800;cursor:pointer}
    .btn-outline{background:#fff;color:#111;border-color:#e6e6ef}
    .btn-danger{background:#ff3b5c}
    .container{padding:18px 22px;max-width:1200px;margin:0 auto}
    .card{background:#fff;border:1px solid #ececf3;border-radius:18px;padding:14px;box-shadow:0 2px 10px rgba(25,25,25,.04)}
    .card h3{margin:0 0 10px 0;font-size:15px}
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .kpi{background:#fff;border:1px solid #ececf3;border-radius:16px;padding:14px}
    .kpi .label{font-size:12px;color:#6b7280}
    .kpi .value{font-size:20px;font-weight:900;margin-top:6px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,select{padding:10px 12px;border-radius:12px;border:1px solid #e6e6ef;background:#fff;outline:none}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:10px 8px;border-bottom:1px solid #eee;text-align:left;vertical-align:top}
    th{font-size:12px;color:#6b7280}
    .muted{color:#6b7280;font-size:12px}
    .flash{padding:10px 12px;border-radius:12px;margin:10px 0;border:1px solid #eaeaf1;background:#fff}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:980px){
      .kpis{grid-template-columns:repeat(2,1fr)}
      .grid2{grid-template-columns:1fr}
    }
  </style>
</head>
<body>

  <div class="topbar">
    <div class="brand">Controle de Gastos</div>
    <div class="actions">
      <a class="btn btn-outline" href="{{ url_for('export_csv') }}">üì§ Exportar</a>
      <a class="btn btn-outline" href="{{ url_for('budgets_page', month=summary.month_key) }}">üî• Or√ßamentos</a>
      <a class="btn btn-outline" href="{{ url_for('categories_list') }}">üè∑Ô∏è Categorias</a>
      <a class="btn btn-outline" href="{{ url_for('rewards_list') }}">üí≥ Pontua√ß√£o</a>
      <a class="btn btn-outline" href="{{ url_for('share_account') }}">üë• Compartilhar</a>
      <a class="btn btn-danger" href="{{ url_for('logout') }}">Sair</a>
    </div>
  </div>

  <div class="container">

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, msg in messages %}
          <div class="flash"><b>{{ category|upper }}</b>: {{ msg }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <div class="card">
      <h3>Fechamento da fatura</h3>
      <form class="row" method="post" action="{{ url_for('set_billing_day_route') }}">
        <span class="muted">Dia do fechamento (1 a 28):</span>
        <input type="number" name="billing_day" min="1" max="28" value="{{ billing_day }}">
        <button class="btn" type="submit">Salvar</button>
        <span class="muted">Ap√≥s o dia {{ billing_day }}, os lan√ßamentos entram no m√™s seguinte.</span>
      </form>

      <div style="margin-top:10px" class="row">
        <span class="muted">M√™s exibido (fatura):</span>
        <select onchange="location = '?month=' + this.value;">
          {% if not months %}
            <option value="{{ summary.month_key }}">{{ summary.month_key }}</option>
          {% else %}
            {% for m in months %}
              <option value="{{ m }}" {% if m==summary.month_key %}selected{% endif %}>{{ m }}</option>
            {% endfor %}
          {% endif %}
        </select>
      </div>
    </div>

    <div style="height:12px"></div>

    <div class="kpis">
      <div class="kpi">
        <div class="label">Renda ({{ summary.month_key }})</div>
        <div class="value">R$ {{ "%.2f"|format(summary.total_income) }}</div>
      </div>
      <div class="kpi">
        <div class="label">Gastos ({{ summary.month_key }})</div>
        <div class="value">R$ {{ "%.2f"|format(summary.total_expenses) }}</div>
      </div>
      <div class="kpi">
        <div class="label">Saldo</div>
        <div class="value">R$ {{ "%.2f"|format(summary.balance) }}</div>
      </div>
      <div class="kpi">
        <div class="label">Pontos (m√™s)</div>
        <div class="value">{{ "%.2f"|format(summary.total_points) }}</div>
      </div>
    </div>

    <div style="height:14px"></div>

    <div class="grid2">

      <div class="card">
        <h3>üî• Or√ßamento por categoria ({{ summary.month_key }})</h3>

        <div class="muted" style="margin-bottom:10px">
          Alerta aos 80% e alerta forte ao estourar.
        </div>

        {% for b in budget_progress %}
          <div style="margin:10px 0">
            <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
              <b>{{ b.category }}</b>

              {% if b.limit %}
                <span class="muted">
                  R$ {{ "%.2f"|format(b.spent) }} / R$ {{ "%.2f"|format(b.limit) }}
                  ({{ "%.0f"|format(b.pct) }}%)
                </span>
              {% else %}
                <span class="muted">Sem or√ßamento definido</span>
              {% endif %}
            </div>

            {% if b.limit %}
              <div style="height:12px;border-radius:999px;background:#eee;overflow:hidden;margin-top:6px">
                <div style="
                  height:12px;
                  width: {{ 100 if b.pct > 100 else b.pct }}%;
                  background: {% if b.status=='over' %} #ff3b5c {% elif b.status=='warn' %} #f59e0b {% else %} #10b981 {% endif %};
                "></div>
              </div>

              {% if b.status == "warn" %}
                <div class="muted" style="margin-top:4px;color:#b45309">
                  ‚ö†Ô∏è Voc√™ j√° atingiu 80% do or√ßamento dessa categoria.
                </div>
              {% elif b.status == "over" %}
                <div class="muted" style="margin-top:4px;color:#be123c">
                  üö® Or√ßamento estourado! Considere reduzir gastos nessa categoria.
                </div>
              {% endif %}
            {% endif %}
          </div>
        {% endfor %}

        <a class="btn btn-outline" href="{{ url_for('budgets_page', month=summary.month_key) }}">Editar or√ßamentos</a>
      </div>

      <div class="card">
        <h3>Novo Lan√ßamento</h3>

        <form class="row" method="post" action="{{ url_for('add_entry') }}">
          <select name="type" required>
            <option value="expense">Despesa</option>
            <option value="income">Receita</option>
          </select>

          <input name="value" placeholder="Valor (ex: 120.50)" required>
          <input name="description" placeholder="Descri√ß√£o (opcional)">

          <select name="category">
            <option value="">(Categoria)</option>
            {% for c in categories %}
              <option value="{{ c }}">{{ c }}</option>
            {% endfor %}
          </select>

          <select name="payment_method">
            <option value="">(Pagamento)</option>
            <option value="credito">Cr√©dito</option>
            <option value="debito">D√©bito</option>
            <option value="pix">Pix</option>
            <option value="dinheiro">Dinheiro</option>
          </select>

          <select name="card_brand">
            <option value="">(Bandeira - se cr√©dito)</option>
            {% for r in reward_rates %}
              <option value="{{ r.brand }}">{{ r.brand }} ({{ r.points_per_currency }}/{{ r.currency_unit }})</option>
            {% endfor %}
          </select>

          <input type="number" name="installments_total" min="2" placeholder="Parcelas (se Parcelas Cart√£o)">
          <input type="date" name="date" value="{{ today_str }}">

          <button class="btn" type="submit">Confirmar</button>

          {% if usd_brl_rate %}
            <span class="muted">USD/BRL: {{ "%.4f"|format(usd_brl_rate) }}</span>
          {% endif %}
        </form>

        <div class="muted" style="margin-top:10px">
          Dica: Se a categoria for <b>Parcelas Cart√£o</b>, informe o total de parcelas para exibir ‚Äúparcelas restantes‚Äù.
        </div>
      </div>

    </div>

    <div style="height:14px"></div>

    <div class="card">
      <h3>Lan√ßamentos</h3>
      <table>
        <thead>
          <tr>
            <th>Data</th>
            <th>Tipo</th>
            <th>Categoria</th>
            <th>Descri√ß√£o</th>
            <th>Pagamento</th>
            <th>Valor</th>
            <th>Pontos</th>
            <th>Parcelas</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody>
          {% for e in entries %}
            <tr>
              <td>{{ e.date }}</td>
              <td>{{ "Receita" if e.type=="income" else "Despesa" }}</td>
              <td>{{ e.category or "-" }}</td>
              <td>{{ e.source or "-" }}</td>
              <td>
                {% if e.payment_method %}
                  {{ e.payment_method }}
                  {% if e.payment_method == "credito" and e.card_brand %}
                    ({{ e.card_brand }})
                  {% endif %}
                {% else %}
                  -
                {% endif %}
              </td>
              <td>R$ {{ "%.2f"|format(e.value) }}</td>
              <td>{{ "%.2f"|format(e.points_earned or 0) }}</td>
              <td>
                {% if e.installments_total %}
                  {{ e.installments_total }}
                  {% if e.installments_remaining_view is not none %}
                    <div class="muted">Restam: {{ e.installments_remaining_view }}</div>
                  {% endif %}
                {% else %}
                  -
                {% endif %}
              </td>
              <td>
                <a class="btn btn-outline" href="{{ url_for('edit_entry', entry_id=e.id) }}">‚úèÔ∏è Editar</a>
                <form style="display:inline" method="post" action="{{ url_for('delete_entry', entry_id=e.id) }}">
                  <button class="btn btn-danger" type="submit">üóëÔ∏è Excluir</button>
                </form>
              </td>
            </tr>
          {% endfor %}
          {% if not entries %}
            <tr><td colspan="9" class="muted">Nenhum lan√ßamento ainda.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>

  </div>
</body>
</html>
